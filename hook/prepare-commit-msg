#!/bin/bash

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Skip for merge commits or amended commits
if [[ "$COMMIT_SOURCE" == "merge" || "$COMMIT_SOURCE" == "commit" ]]; then
  exit 0
fi

# Call gRPC server using reflection
GENERATED_MSG=$(grpcurl -plaintext \
  -d "{\"message\": \"Commit message\"}" \
  localhost:50051 \
  GITCommitMessage.GITCommitMessage/GetCommitMessage)

echo "Generated message: $GENERATED_MSG"

# Extract "message" field without jq
FINAL_MSG=$(echo "$GENERATED_MSG" | sed -n 's/.*"message": "\(.*\)",.*/\1/p')

# Overwrite the commit message file
echo "$FINAL_MSG" > "$COMMIT_MSG_FILE"
